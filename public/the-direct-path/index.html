<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Direct Path - Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Cosmic Glow -->
    <!-- Application Structure Plan: De applicatie is gestructureerd als een single-page, multi-view layout, beheerd door JavaScript om een naadloze, app-achtige ervaring te simuleren zonder paginaherlaadbeurten. De flow begint met een verplichte, modale onboarding die de gebruiker introduceert tot de kernconcepten. Daarna landt de gebruiker op een centraal 'Home' scherm dat fungeert als een portaal. Vanaf hier kan de gebruiker via een tab-balk of interactieve kaarten navigeren naar de verschillende kernfuncties (Quick Shift, Mentor, Journal, Pad). Elke functie is een aparte 'view' die de andere vervangt. Deze hub-and-spoke structuur is gekozen omdat het de informatierijke brontekst opdeelt in behapbare, taakgerichte secties, wat de navigatie intu√Øtief maakt en de gebruiker in staat stelt zich op √©√©n aspect tegelijk te concentreren, in lijn met de meditatieve aard van de app. -->
    <!-- Visualization & Content Choices: 
        - Home Screen: Doel: Centrale navigatie. Methode: HTML/Tailwind kaarten. Interactie: Klikken om van view te wisselen. Justificatie: Biedt een duidelijk overzicht en directe toegang.
        - Onboarding: Doel: Introductie. Methode: Modale pop-up met slides. Interactie: Klikken om door te gaan. Justificatie: Cre√´ert een gerichte, ononderbroken eerste ervaring.
        - Quick Shift: Doel: Immersieve meditatie. Methode: HTML Canvas animatie. Interactie: Start automatisch, toont resultaat na 60s. Justificatie: Canvas biedt de nodige grafische flexibiliteit voor een unieke, vloeiende visuele ervaring die niet met standaard HTML/CSS mogelijk is.
        - AI Mentor: Doel: Gesimuleerde chat. Methode: HTML/CSS chatbubbels, nu met Gemini API. Interactie: Gebruiker typt, JS genereert antwoord via LLM. Justificatie: Bootst een realistische chat-ervaring na, verrijkt met dynamische LLM-antwoorden.
        - Journal: Doel: Reflectie vastleggen en verdiepen. Methode: HTML textarea met LLM-knop. Interactie: Tekst invoeren, opslaan, LLM-inzicht genereren. Justificatie: Eenvoudige en directe methode voor tekstinvoer, uitgebreid met LLM voor diepere reflectie.
        - Mijn Pad: Doel: Abstracte progressie tonen. Methode: Chart.js (Polar Area Chart). Interactie: Knop om progressie te simuleren. Justificatie: Chart.js is ideaal voor datavisualisatie; een Polar Area chart kan een groeiende, mandala-achtige vorm cre√´ren die 'verdieping' symboliseert zonder harde cijfers te gebruiken.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0B0014;
            color: #E0E0E0;
        }
        .cosmic-bg {
            background-color: #0B0014;
            background-image: 
                radial-gradient(circle at 25% 30%, rgba(100, 100, 220, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 70%, rgba(180, 50, 200, 0.1) 0%, transparent 50%);
            background-attachment: fixed;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .neon-glow {
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.5), 0 0 10px rgba(0, 255, 255, 0.3), 0 0 15px rgba(0, 255, 255, 0.2);
        }
        .pulse {
            animation: pulse-animation 2s infinite;
        }
        @keyframes pulse-animation {
            0% { box-shadow: 0 0 5px rgba(0, 255, 255, 0.5), 0 0 10px rgba(0, 255, 255, 0.3); }
            50% { box-shadow: 0 0 15px rgba(0, 255, 255, 0.8), 0 0 25px rgba(0, 255, 255, 0.5); }
            100% { box-shadow: 0 0 5px rgba(0, 255, 255, 0.5), 0 0 10px rgba(0, 255, 255, 0.3); }
        }
        .nav-item.active {
            color: #00ffff;
            border-bottom: 2px solid #00ffff;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #00ffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="cosmic-bg">

    <div id="app-container" class="max-w-md mx-auto h-screen flex flex-col bg-[#0B0014] shadow-2xl shadow-cyan-500/10">
        
        <!-- Main Content Area -->
        <main class="flex-grow overflow-y-auto p-4 pb-20">
            
            <!-- Onboarding Modal -->
            <div id="onboarding-modal" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex flex-col justify-center items-center p-6 text-center">
                <div id="onboarding-step-1" class="onboarding-step">
                    <div class="text-6xl mb-6">üåå</div>
                    <h2 class="text-3xl font-bold text-cyan-300 mb-2" data-key="welcome"></h2>
                    <p class="text-lg text-gray-300" data-key="portal"></p>
                    <button onclick="showOnboardingStep(2)" class="mt-8 bg-cyan-500 text-black font-bold py-3 px-8 rounded-full shadow-lg neon-glow transition-transform duration-300 hover:scale-105" data-key="startJourney"></button>
                </div>
                <div id="onboarding-step-2" class="onboarding-step hidden">
                    <div class="text-6xl mb-6">‚ú®</div>
                    <h2 class="text-3xl font-bold text-purple-400 mb-2" data-key="meetMentor"></h2>
                    <p class="text-lg text-gray-300" data-key="mentorGuide"></p>
                    <button onclick="showOnboardingStep(3)" class="mt-8 bg-purple-500 text-black font-bold py-3 px-8 rounded-full shadow-lg shadow-purple-500/50 transition-transform duration-300 hover:scale-105" data-key="discoverPossibilities"></button>
                </div>
                <div id="onboarding-step-3" class="onboarding-step hidden">
                    <div class="text-6xl mb-6">üßò‚Äç‚ôÄÔ∏è</div>
                    <h2 class="text-3xl font-bold text-white mb-2" data-key="findPeace"></h2>
                    <p class="text-lg text-gray-300" data-key="experienceShifts"></p>
                    <button onclick="finishOnboarding()" class="mt-8 bg-white text-black font-bold py-3 px-8 rounded-full shadow-lg shadow-white/50 transition-transform duration-300 hover:scale-105" data-key="startQuickShift"></button>
                </div>
            </div>

            <!-- Home Screen -->
            <div id="home-screen" class="app-screen hidden">
                <div class="flex justify-between items-center mb-4">
                    <div class="text-center flex-grow">
                        <h1 class="text-3xl font-bold text-white" data-key="welcomeBack"></h1>
                        <p class="text-gray-400" data-key="readyForClarity"></p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label for="language-select" class="text-sm text-gray-400" data-key="language"></label>
                        <select id="language-select" onchange="setLanguage(this.value)" class="bg-gray-800 text-white text-sm rounded-lg p-1">
                            <option value="nl">NL</option>
                            <option value="en">EN</option>
                            <option value="de">DE</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex justify-center items-center mb-8">
                    <button onclick="showScreen('quick-shift-screen'); startQuickShift()" class="w-48 h-48 bg-gray-800 rounded-full flex flex-col justify-center items-center border-4 border-cyan-500 pulse transition-transform duration-300 hover:scale-105">
                        <span class="text-2xl font-bold text-white" data-key="quickShift"></span>
                        <span class="text-lg text-cyan-300" data-key="seconds"></span>
                    </button>
                </div>

                <div class="space-y-4">
                    <div onclick="showScreen('journal-screen')" class="glass-card p-4 rounded-2xl flex items-center space-x-4 cursor-pointer transition-all duration-300 hover:border-cyan-400">
                        <div class="text-3xl">üìù</div>
                        <div>
                            <h3 class="font-bold text-white" data-key="dailyReflection"></h3>
                            <p class="text-sm text-gray-400" data-key="todayReflection"></p>
                        </div>
                    </div>
                    <div onclick="showScreen('mentor-screen')" class="glass-card p-4 rounded-2xl flex items-center space-x-4 cursor-pointer transition-all duration-300 hover:border-purple-400">
                        <div class="text-3xl">‚ú®</div>
                        <div>
                            <h3 class="font-bold text-white" data-key="aiMentor"></h3>
                            <p class="text-sm text-gray-400" data-key="mentorWaiting"></p>
                        </div>
                    </div>
                    <div class="glass-card p-4 rounded-2xl flex items-center space-x-4">
                        <div class="text-3xl">‚è≥</div>
                        <div>
                            <h3 class="font-bold text-white" data-key="liveCircles"></h3>
                            <p class="text-sm text-gray-400" data-key="nextCircle"></p>
                        </div>
                    </div>
                    <div onclick="showScreen('progress-screen')" class="glass-card p-4 rounded-2xl flex items-center space-x-4 cursor-pointer transition-all duration-300 hover:border-yellow-400">
                        <div class="text-3xl">üåÄ</div>
                        <div>
                            <h3 class="font-bold text-white" data-key="myPath"></h3>
                            <p class="text-sm text-gray-400" data-key="visualizeDeepening"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Shift Screen -->
            <div id="quick-shift-screen" class="app-screen hidden h-full flex flex-col justify-center items-center text-center">
                 <p id="quick-shift-text" class="text-xl text-gray-300 mb-4" data-key="breatheIn"></p>
                 <canvas id="quick-shift-canvas" width="300" height="300"></canvas>
                 <div id="quick-shift-results" class="hidden mt-8">
                    <h2 class="text-3xl font-bold text-cyan-300" data-key="shiftComplete"></h2>
                    <div class="mt-6 flex space-x-4">
                        <button onclick="startQuickShift()" class="bg-gray-700 text-white font-bold py-2 px-6 rounded-full" data-key="repeat"></button>
                        <button onclick="showScreen('journal-screen')" class="bg-cyan-500 text-black font-bold py-2 px-6 rounded-full neon-glow" data-key="goToReflection"></button>
                    </div>
                 </div>
            </div>

            <!-- Journal Screen -->
            <div id="journal-screen" class="app-screen hidden">
                <h2 class="text-2xl font-bold mb-4 text-cyan-300" data-key="dailyReflection"></h2>
                <p class="mb-4 text-gray-300" data-key="journalPrompt"></p>
                <textarea id="journal-entry" class="w-full h-64 p-4 bg-gray-800 border border-gray-700 rounded-2xl text-white focus:outline-none focus:ring-2 focus:ring-cyan-500" data-key="writeInsights" placeholder=""></textarea>
                <div class="mt-4 flex justify-end space-x-3">
                    <button class="bg-gray-700 text-white font-bold py-2 px-5 rounded-full" data-key="save"></button>
                    <button onclick="generateJournalInsight()" class="bg-purple-500 text-black font-bold py-2 px-5 rounded-full flex items-center justify-center">
                        <span id="journal-insight-loading" class="loading-spinner hidden mr-2"></span>
                        <span data-key="generateInsight"></span>
                    </button>
                </div>
                <div id="journal-insight-output" class="mt-6 p-4 glass-card rounded-2xl hidden">
                    <h3 class="font-bold text-white mb-2" data-key="yourInsight"></h3>
                    <p class="text-sm text-gray-300"></p>
                </div>
            </div>

            <!-- AI Mentor Screen -->
            <div id="mentor-screen" class="app-screen hidden h-full flex flex-col">
                <div class="text-center mb-4">
                    <div class="inline-block text-5xl animate-pulse">‚ú®</div>
                    <h2 class="text-2xl font-bold text-purple-400" data-key="aiMentor"></h2>
                </div>
                <div id="chat-window" class="flex-grow bg-black bg-opacity-20 rounded-2xl p-4 space-y-4 overflow-y-auto">
                    <div class="flex justify-start">
                        <div class="bg-gray-700 p-3 rounded-2xl max-w-xs">
                            <p data-key="mentorWelcome"></p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex">
                    <input id="chat-input" type="text" class="flex-grow bg-gray-800 border border-gray-700 rounded-l-full p-3 text-white focus:outline-none focus:ring-2 focus:ring-purple-500" data-key="askQuestion" placeholder="">
                    <button onclick="sendChatMessage()" class="bg-purple-500 text-black font-bold px-6 rounded-r-full flex items-center justify-center">
                        <span id="mentor-loading" class="loading-spinner hidden mr-2"></span>
                        <span data-key="send"></span>
                    </button>
                </div>
            </div>
            
            <!-- Progress Screen -->
            <div id="progress-screen" class="app-screen hidden">
                <h2 class="text-2xl font-bold mb-4 text-yellow-300 text-center" data-key="myPath"></h2>
                <p class="text-center text-gray-400 mb-4" data-key="abstractJourney"></p>
                <div class="chart-container">
                    <canvas id="progress-chart"></canvas>
                </div>
                <div class="text-center mt-6">
                    <button onclick="updateProgressChart()" class="bg-yellow-500 text-black font-bold py-2 px-6 rounded-full" data-key="simulatePractice"></button>
                </div>
            </div>

        </main>

        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto h-16 bg-gray-900 bg-opacity-80 backdrop-blur-sm flex justify-around items-center border-t border-gray-700">
            <button onclick="showScreen('home-screen')" class="nav-item p-2 active" data-screen="home-screen">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
            </button>
            <button onclick="showScreen('journal-screen')" class="nav-item p-2" data-screen="journal-screen">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
            </button>
            <button onclick="showScreen('mentor-screen')" class="nav-item p-2" data-screen="mentor-screen">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
            </button>
            <button onclick="showScreen('progress-screen')" class="nav-item p-2" data-screen="progress-screen">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
            </button>
        </nav>
    </div>

    <script>
        let currentScreen = 'onboarding-modal';
        let progressChart;
        const progressData = {
            labels: [], // Labels will be set dynamically
            datasets: [{
                label: 'Verdieping', // This label will also be dynamic
                data: [10, 10, 10, 10, 10],
                backgroundColor: [
                    'rgba(0, 255, 255, 0.3)',
                    'rgba(191, 0, 255, 0.3)',
                    'rgba(255, 255, 0, 0.3)',
                    'rgba(0, 255, 128, 0.3)',
                    'rgba(255, 100, 100, 0.3)'
                ],
                borderColor: [
                    'rgba(0, 255, 255, 1)',
                    'rgba(191, 0, 255, 1)',
                    'rgba(255, 255, 0, 1)',
                    'rgba(0, 255, 128, 1)',
                    'rgba(255, 100, 100, 1)'
                ],
                borderWidth: 1
            }]
        };

        const translations = {
            nl: {
                welcome: "Welkom bij The Direct Path.",
                portal: "Een portaal naar innerlijke realisatie, voorbij dogma's.",
                startJourney: "Begin je reis",
                meetMentor: "Ontmoet je AI Mentor.",
                mentorGuide: "Jouw persoonlijke gids voor zelfonderzoek en diepe reflectie.",
                discoverPossibilities: "Ontdek de mogelijkheden",
                findPeace: "Vind Rust, Leg Inzichten Vast.",
                experienceShifts: "Ervaar snelle verschuivingen in 60 seconden en leg je diepste reflecties vast.",
                startQuickShift: "Start je eerste Quick Shift",
                welcomeBack: "Welkom Terug",
                readyForClarity: "Klaar voor een moment van helderheid?",
                quickShift: "Quick Shift",
                seconds: "60 seconden",
                dailyReflection: "Dagelijkse Reflectie",
                todayReflection: "Vandaag: Wat is de aard van stilte?",
                aiMentor: "AI Mentor",
                mentorWaiting: "Jouw gids wacht.",
                liveCircles: "Live Cirkels",
                nextCircle: "Volgende: Morgen om 20:00 uur",
                myPath: "Mijn Pad",
                visualizeDeepening: "Visualiseer je verdieping in bewustzijn.",
                breatheIn: "Adem in... adem uit...",
                shiftComplete: "Shift voltooid.",
                repeat: "Herhaal",
                goToReflection: "Ga naar Reflectie",
                journalPrompt: "Waar ervaar je een gevoel van eenheid in je dagelijks leven?",
                writeInsights: "Schrijf je inzichten hier...",
                save: "Opslaan",
                share: "Delen",
                generateInsight: "‚ú® Genereer Inzicht",
                yourInsight: "Jouw Inzicht:",
                writeFirst: "Schrijf eerst iets in je journal om een inzicht te genereren.",
                mentorWelcome: "Welkom. Waar denk je aan op dit moment?",
                askQuestion: "Stel je vraag...",
                send: "Zend",
                abstractJourney: "Dit is een abstracte weergave van je reis. Er is geen doel, alleen ontvouwing.",
                simulatePractice: "Simuleer 7 dagen beoefening",
                selfInquiry: "Zelfonderzoek",
                meditation: "Meditatie",
                reflection: "Reflectie",
                community: "Community",
                insight: "Inzicht",
                apiError: "Er is een fout opgetreden bij het genereren van een antwoord. Probeer het later opnieuw.",
                language: "Taal",
                languagePrompt: "Antwoord in het Nederlands."
            },
            en: {
                welcome: "Welcome to The Direct Path.",
                portal: "A portal to inner realization, beyond dogmas.",
                startJourney: "Start your journey",
                meetMentor: "Meet your AI Mentor.",
                mentorGuide: "Your personal guide for self-inquiry and deep reflection.",
                discoverPossibilities: "Discover the possibilities",
                findPeace: "Find Peace, Capture Insights.",
                experienceShifts: "Experience quick shifts in 60 seconds and capture your deepest reflections.",
                startQuickShift: "Start your first Quick Shift",
                welcomeBack: "Welcome Back",
                readyForClarity: "Ready for a moment of clarity?",
                quickShift: "Quick Shift",
                seconds: "60 seconds",
                dailyReflection: "Daily Reflection",
                todayReflection: "Today: What is the nature of silence?",
                aiMentor: "AI Mentor",
                mentorWaiting: "Your guide awaits.",
                liveCircles: "Live Circles",
                nextCircle: "Next: Tomorrow at 8:00 PM",
                myPath: "My Path",
                visualizeDeepening: "Visualize your deepening in consciousness.",
                breatheIn: "Breathe in... breathe out...",
                shiftComplete: "Shift complete.",
                repeat: "Repeat",
                goToReflection: "Go to Reflection",
                journalPrompt: "Where do you experience a sense of unity in your daily life?",
                writeInsights: "Write your insights here...",
                save: "Save",
                share: "Share",
                generateInsight: "‚ú® Generate Insight",
                yourInsight: "Your Insight:",
                writeFirst: "First, write something in your journal to generate an insight.",
                mentorWelcome: "Welcome. What are you thinking about right now?",
                askQuestion: "Ask your question...",
                send: "Send",
                abstractJourney: "This is an abstract representation of your journey. There is no goal, only unfolding.",
                simulatePractice: "Simulate 7 days of practice",
                selfInquiry: "Self-Inquiry",
                meditation: "Meditation",
                reflection: "Reflection",
                community: "Community",
                insight: "Insight",
                apiError: "An error occurred while generating a response. Please try again later.",
                language: "Language",
                languagePrompt: "Respond in English."
            },
            de: {
                welcome: "Willkommen bei The Direct Path.",
                portal: "Ein Portal zur inneren Verwirklichung, jenseits von Dogmen.",
                startJourney: "Beginne deine Reise",
                meetMentor: "Treffe deinen KI Mentor.",
                mentorGuide: "Dein pers√∂nlicher F√ºhrer f√ºr Selbstforschung und tiefe Reflexion.",
                discoverPossibilities: "Entdecke die M√∂glichkeiten",
                findPeace: "Finde Ruhe, Erfasse Erkenntnisse.",
                experienceShifts: "Erlebe schnelle Ver√§nderungen in 60 Sekunden und halte deine tiefsten Reflexionen fest.",
                startQuickShift: "Starte deine erste Quick Shift",
                welcomeBack: "Willkommen zur√ºck",
                readyForClarity: "Bereit f√ºr einen Moment der Klarheit?",
                quickShift: "Quick Shift",
                seconds: "60 Sekunden",
                dailyReflection: "T√§gliche Reflexion",
                todayReflection: "Heute: Was ist die Natur der Stille?",
                aiMentor: "KI Mentor",
                mentorWaiting: "Dein F√ºhrer wartet.",
                liveCircles: "Live Kreise",
                nextCircle: "N√§chster: Morgen um 20:00 Uhr",
                myPath: "Mein Pfad",
                visualizeDeepening: "Visualisiere deine Vertiefung des Bewusstseins.",
                breatheIn: "Atme ein... atme aus...",
                shiftComplete: "Verschiebung abgeschlossen.",
                repeat: "Wiederholen",
                goToReflection: "Gehe zur Reflexion",
                journalPrompt: "Wo erlebst du ein Gef√ºhl der Einheit in deinem t√§glichen Leben?",
                writeInsights: "Schreibe deine Erkenntnisse hier...",
                save: "Speichern",
                share: "Teilen",
                generateInsight: "‚ú® Erkenntnis generieren",
                yourInsight: "Deine Erkenntnis:",
                writeFirst: "Schreibe zuerst etwas in dein Journal, um eine Erkenntnis zu generieren.",
                mentorWelcome: "Willkommen. Woran denkst du gerade?",
                askQuestion: "Stelle deine Frage...",
                send: "Senden",
                abstractJourney: "Dies ist eine abstrakte Darstellung deiner Reise. Es gibt kein Ziel, nur Entfaltung.",
                simulatePractice: "Simuliere 7 Tage Praxis",
                selfInquiry: "Selbstforschung",
                meditation: "Meditation",
                reflection: "Reflexion",
                community: "Gemeinschaft",
                insight: "Erkenntnis",
                apiError: "Beim Generieren einer Antwort ist ein Fehler aufgetreten. Bitte versuche es sp√§ter erneut.",
                language: "Sprache",
                languagePrompt: "Antworte auf Deutsch."
            }
        };

        let currentLanguage = localStorage.getItem('appLanguage') || 'nl'; // Default to Dutch

        let chatHistory = [];
        const API_KEY = ""; // Leave as-is. Canvas will automatically provide it.

        function setLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('appLanguage', lang);
            updateTexts();
            // Update progress chart labels immediately after language change
            if (progressChart) {
                progressChart.data.labels = [
                    translations[currentLanguage].selfInquiry,
                    translations[currentLanguage].meditation,
                    translations[currentLanguage].reflection,
                    translations[currentLanguage].community,
                    translations[currentLanguage].insight
                ];
                progressChart.update();
            }
            // Update the selected option in the dropdown
            document.getElementById('language-select').value = lang;
        }

        function updateTexts() {
            const t = translations[currentLanguage];

            // Elements with data-key attribute
            document.querySelectorAll('[data-key]').forEach(element => {
                const key = element.getAttribute('data-key');
                if (t[key]) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                        element.placeholder = t[key];
                    } else if (element.tagName === 'TEXTAREA' && element.hasAttribute('placeholder')) {
                        element.placeholder = t[key];
                    } else {
                        element.textContent = t[key];
                    }
                }
            });

            // Specific elements that need innerHTML for spinner
            document.querySelector('#journal-screen button:nth-child(2)').innerHTML = `<span id="journal-insight-loading" class="loading-spinner hidden mr-2"></span><span data-key="generateInsight">${t.generateInsight}</span>`;
            document.querySelector('#mentor-screen button').innerHTML = `<span id="mentor-loading" class="loading-spinner hidden mr-2"></span><span data-key="send">${t.send}</span>`;
            
            // Re-select the correct placeholder text after updating
            document.getElementById('journal-entry').placeholder = t.writeInsights;
            document.getElementById('chat-input').placeholder = t.askQuestion;
        }

        function showScreen(screenId) {
            document.querySelectorAll('.app-screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            currentScreen = screenId;
            updateNav();
        }

        function updateNav() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.screen === currentScreen) {
                    item.classList.add('active');
                }
            });
        }

        function showOnboardingStep(step) {
            document.querySelectorAll('.onboarding-step').forEach(s => s.classList.add('hidden'));
            document.getElementById(`onboarding-step-${step}`).classList.remove('hidden');
        }

        function finishOnboarding() {
            const modal = document.getElementById('onboarding-modal');
            modal.classList.add('transition-opacity', 'duration-500', 'opacity-0');
            sessionStorage.setItem('onboardingComplete', 'true'); // Mark onboarding as complete
            setTimeout(() => {
                modal.classList.add('hidden');
                showScreen('home-screen');
            }, 500);
        }

        function startQuickShift() {
            const canvas = document.getElementById('quick-shift-canvas');
            const resultsDiv = document.getElementById('quick-shift-results');
            const textP = document.getElementById('quick-shift-text');
            const ctx = canvas.getContext('2d');
            let frame = 0;
            let animationId;

            resultsDiv.classList.add('hidden');
            textP.classList.remove('hidden');
            textP.textContent = translations[currentLanguage].breatheIn;

            function draw() {
                frame++;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const progress = frame / (60 * 60); // 60fps for 60s
                
                // Progress circle
                ctx.beginPath();
                ctx.arc(150, 150, 140, -Math.PI / 2, 2 * Math.PI * progress - Math.PI / 2);
                ctx.strokeStyle = 'rgba(0, 255, 255, 0.5)';
                ctx.lineWidth = 4;
                ctx.stroke();

                // Pulsing orb/spiral
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    const radius = 50 + i * 20 + Math.sin(frame * 0.05 + i) * 10;
                    const alpha = 0.2 + Math.sin(frame * 0.05 + i) * 0.1;
                    ctx.arc(150, 150, radius, 0, 2 * Math.PI);
                    ctx.strokeStyle = `rgba(170, 80, 255, ${alpha})`;
                    ctx.lineWidth = 2 + Math.sin(frame * 0.05 + i);
                    ctx.stroke();
                }

                if (progress >= 1) {
                    cancelAnimationFrame(animationId);
                    resultsDiv.classList.remove('hidden');
                    textP.classList.add('hidden');
                    return;
                }
                animationId = requestAnimationFrame(draw);
            }

            draw();
        }
        
        async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
            let chatHistoryForAPI = [];
            chatHistoryForAPI.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistoryForAPI };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        await new Promise(res => setTimeout(res, delay));
                        return callGeminiAPI(prompt, retries - 1, delay * 2);
                    }
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    throw new Error('Unexpected API response structure or no content.');
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                return translations[currentLanguage].apiError;
            }
        }

        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const chatWindow = document.getElementById('chat-window');
            const loadingSpinner = document.getElementById('mentor-loading');
            const message = input.value.trim();

            if (message === '') return;

            // Display user message
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'flex justify-end';
            userMessageDiv.innerHTML = `<div class="bg-purple-600 p-3 rounded-2xl max-w-xs text-white"><p>${message}</p></div>`;
            chatWindow.appendChild(userMessageDiv);
            chatHistory.push({ role: "user", parts: [{ text: message }] }); // Add to history

            input.value = '';
            chatWindow.scrollTop = chatWindow.scrollHeight;
            loadingSpinner.classList.remove('hidden'); // Show loading spinner

            const aiPrompt = `Je bent een AI Mentor voor een spirituele zelfontdekkingsapp, gericht op non-dualiteit en innerlijke realisatie. Beantwoord de volgende vraag op een kalme, inzichtelijke en non-duale manier. Focus op zelfonderzoek en het loslaten van concepten. ${translations[currentLanguage].languagePrompt} Hier is de vraag: "${message}"`;
            const aiResponse = await callGeminiAPI(aiPrompt);

            loadingSpinner.classList.add('hidden'); // Hide loading spinner

            // Display AI response
            const aiMessageDiv = document.createElement('div');
            aiMessageDiv.className = 'flex justify-start';
            aiMessageDiv.innerHTML = `<div class="bg-gray-700 p-3 rounded-2xl max-w-xs"><p>${aiResponse}</p></div>`;
            chatWindow.appendChild(aiMessageDiv);
            chatHistory.push({ role: "model", parts: [{ text: aiResponse }] }); // Add to history
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        async function generateJournalInsight() {
            const journalEntry = document.getElementById('journal-entry').value.trim();
            const insightOutputDiv = document.getElementById('journal-insight-output');
            const insightTextP = insightOutputDiv.querySelector('p');
            const loadingSpinner = document.getElementById('journal-insight-loading');

            if (journalEntry === '') {
                insightOutputDiv.classList.remove('hidden');
                insightTextP.textContent = translations[currentLanguage].writeFirst;
                return;
            }

            loadingSpinner.classList.remove('hidden'); // Show loading spinner
            insightOutputDiv.classList.add('hidden'); // Hide previous insight
            
            const prompt = `Analyseer de volgende journal-entry vanuit een non-duaal perspectief en geef een kort, diepgaand inzicht of een verdiepende vraag. Focus op bewustzijn, eenheid of het loslaten van identificatie. ${translations[currentLanguage].languagePrompt} Hier is de entry: "${journalEntry}"`;
            const insight = await callGeminiAPI(prompt);

            loadingSpinner.classList.add('hidden'); // Hide loading spinner
            insightOutputDiv.classList.remove('hidden');
            insightTextP.textContent = insight;
        }

        function createProgressChart() {
            const ctx = document.getElementById('progress-chart').getContext('2d');
            if(progressChart) {
                progressChart.destroy();
            }
            progressChart = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: [
                        translations[currentLanguage].selfInquiry,
                        translations[currentLanguage].meditation,
                        translations[currentLanguage].reflection,
                        translations[currentLanguage].community,
                        translations[currentLanguage].insight
                    ],
                    datasets: progressData.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            display: false
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#E0E0E0'
                            }
                        }
                    }
                }
            });
        }
        
        function updateProgressChart() {
            progressData.datasets[0].data = progressData.datasets[0].data.map(val => val + Math.random() * 5 + 2);
            createProgressChart(); // Re-create to update labels if needed
        }
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            // Set initial language from localStorage or default
            setLanguage(currentLanguage);

            // Check if onboarding was completed
            if (sessionStorage.getItem('onboardingComplete')) {
                document.getElementById('onboarding-modal').classList.add('hidden');
                showScreen('home-screen');
            } else {
                showOnboardingStep(1); // Start onboarding if not completed
            }
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => showScreen(item.dataset.screen));
            });

            createProgressChart();
        });

    </script>
</body>
</html>
